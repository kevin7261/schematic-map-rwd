/** * ğŸ“Š åœ–å±¤è³‡è¨Šé¡¯ç¤ºçµ„ä»¶ (Layer Information Display Component) * * åŠŸèƒ½æ¦‚è¿° (Function Overview): *
æœ¬çµ„ä»¶è² è²¬é¡¯ç¤ºç•¶å‰é¸ä¸­åœ–å±¤çš„è©³ç´°è³‡è¨Šï¼ŒåŒ…æ‹¬åŸºæœ¬çµ±è¨ˆæ•¸æ“šã€é …ç›®æ•¸é‡ã€ *
ä»¥åŠç›¸é—œçš„æŠ€è¡“åƒæ•¸ã€‚æä¾›ç›´è§€çš„åœ–å±¤è³‡è¨ŠæŸ¥çœ‹ä»‹é¢ã€‚ * * ä¸»è¦åŠŸèƒ½ (Main Features): * 1. ğŸ“‹
åœ–å±¤è³‡è¨Šå±•ç¤ºï¼šé¡¯ç¤ºç•¶å‰é¸ä¸­åœ–å±¤çš„åŸºæœ¬è³‡è¨Šå’Œçµ±è¨ˆæ•¸æ“š * 2. ğŸ“Š
é …ç›®æ•¸é‡çµ±è¨ˆï¼šè¨ˆç®—ä¸¦é¡¯ç¤ºåœ–å±¤ä¸­åŒ…å«çš„è³‡æ–™é …ç›®ç¸½æ•¸ * 3. ğŸ”„
å¤šåœ–å±¤æ”¯æ´ï¼šæ”¯æ´å¤šå€‹åœ–å±¤çš„åˆ†é åˆ‡æ›å’Œè³‡è¨Šé¡¯ç¤º * 4. ğŸ“± éŸ¿æ‡‰å¼è¨­è¨ˆï¼šé©é…ä¸åŒè¢å¹•å°ºå¯¸çš„é¡¯ç¤ºéœ€æ±‚ * 5. ğŸ¯
å³æ™‚æ›´æ–°ï¼šç•¶åœ–å±¤ç‹€æ…‹è®ŠåŒ–æ™‚è‡ªå‹•æ›´æ–°é¡¯ç¤ºå…§å®¹ * 6. ğŸ“ æŠ€è¡“åƒæ•¸é¡¯ç¤ºï¼šé¡¯ç¤º D3.js ç¹ªåœ–å€åŸŸçš„å°ºå¯¸è³‡è¨Š * *
æŠ€è¡“ç‰¹é» (Technical Features): * - ä½¿ç”¨ Vue 3 Composition API é€²è¡Œç¾ä»£åŒ–ç‹€æ…‹ç®¡ç† * - æ•´åˆ Pinia
ç‹€æ…‹ç®¡ç†ç³»çµ±å¯¦ç¾è·¨çµ„ä»¶æ•¸æ“šå…±äº« * - æ”¯æ´å‹•æ…‹åœ–å±¤åˆ‡æ›å’Œè³‡è¨Šå³æ™‚æ›´æ–° * - æä¾›ç°¡æ½”ç›´è§€çš„åœ–å±¤è³‡è¨Šå±•ç¤ºä»‹é¢
* - å…·å‚™è¼‰å…¥ç‹€æ…‹æŒ‡ç¤ºå’ŒéŒ¯èª¤è™•ç†æ©Ÿåˆ¶ * * é¡¯ç¤ºå…§å®¹ (Display Content): * -
é …ç›®æ•¸é‡ï¼šç•¶å‰åœ–å±¤åŒ…å«çš„è³‡æ–™é …ç›®ç¸½æ•¸ * - åœ–å±¤æ¨™é¡Œï¼šåŒ…å«ç¾¤çµ„åç¨±å’Œåœ–å±¤åç¨±çš„å®Œæ•´æ¨™é¡Œ * -
åˆ†é å°èˆªï¼šæ”¯æ´å¤šåœ–å±¤çš„åˆ†é åˆ‡æ›åŠŸèƒ½ * - æŠ€è¡“åƒæ•¸ï¼šD3.js ç¹ªåœ–å€åŸŸçš„å¯¬åº¦å’Œé«˜åº¦è³‡è¨Š * -
è¼‰å…¥ç‹€æ…‹ï¼šé¡¯ç¤ºè³‡æ–™è¼‰å…¥é€²åº¦å’Œç‹€æ…‹ * * @file layerInfoTab.vue * @version 2.1.0 * @author Kevin Cheng *
@since 1.0.0 * @updated 2024 - é‡æ§‹ç‚ºåœ–å±¤è³‡è¨Šé¡¯ç¤ºçµ„ä»¶ */
<script setup>
  // ==================== ğŸ“¦ ç¬¬ä¸‰æ–¹åº«å¼•å…¥ (Third-Party Library Imports) ====================

  /**
   * Vue 3 Composition API æ ¸å¿ƒåŠŸèƒ½å¼•å…¥
   * æä¾›éŸ¿æ‡‰å¼æ•¸æ“šç®¡ç†ã€è¨ˆç®—å±¬æ€§ã€ç”Ÿå‘½é€±æœŸé‰¤å­ç­‰ç¾ä»£åŒ– Vue é–‹ç™¼åŠŸèƒ½
   *
   * @description åŒ…å«ï¼š
   * - ref: å‰µå»ºéŸ¿æ‡‰å¼åŸºæœ¬é¡å‹æ•¸æ“š
   * - computed: å‰µå»ºè¨ˆç®—å±¬æ€§ï¼Œè‡ªå‹•è¿½è¹¤ä¾è³´è®ŠåŒ–
   * - watch: ç›£è½éŸ¿æ‡‰å¼æ•¸æ“šè®ŠåŒ–
   * - onMounted: çµ„ä»¶æ›è¼‰å®Œæˆå¾Œçš„ç”Ÿå‘½é€±æœŸé‰¤å­
   *
   * @see https://vuejs.org/guide/extras/composition-api-faq.html
   */
  import { ref, computed, watch, onMounted } from 'vue';

  /**
   * Pinia ç‹€æ…‹ç®¡ç†åº«å¼•å…¥
   * æä¾›é›†ä¸­å¼ç‹€æ…‹ç®¡ç†å’Œè·¨çµ„ä»¶æ•¸æ“šå…±äº«èƒ½åŠ›
   *
   * @description ä¸»è¦åŠŸèƒ½ï¼š
   * - é›†ä¸­ç®¡ç†æ‡‰ç”¨ç¨‹å¼å…¨åŸŸç‹€æ…‹
   * - æä¾›éŸ¿æ‡‰å¼ç‹€æ…‹æ›´æ–°æ©Ÿåˆ¶
   * - æ”¯æ´è·¨çµ„ä»¶ç‹€æ…‹å…±äº«
   * - æ•´åˆé–‹ç™¼è€…å·¥å…·æ”¯æ´
   *
   * @see https://pinia.vuejs.org/introduction.html
   */
  import { useDataStore } from '@/stores/dataStore.js';

  /**
   * å·¥å…·å‡½æ•¸å¼•å…¥
   * æä¾›åœ–ç¤º HTML ç”Ÿæˆå’Œçµ„ä»¶å¼•å…¥åŠŸèƒ½
   */
  import { getIconHtml } from '../utils/utils.js';
  import DetailItem from '../components/DetailItem.vue';

  // ==================== ğŸª ç‹€æ…‹ç®¡ç†åˆå§‹åŒ– (State Management Initialization) ====================

  /**
   * ç²å– Pinia æ•¸æ“šå­˜å„²å¯¦ä¾‹
   * ç”¨æ–¼è¨ªå•å…¨åŸŸç‹€æ…‹å’Œåœ–å±¤æ•¸æ“šï¼Œå¯¦ç¾çµ„ä»¶é–“çš„æ•¸æ“šå…±äº«
   *
   * @type {Object} Pinia store å¯¦ä¾‹
   * @description æä¾›å°å…¨åŸŸåœ–å±¤æ•¸æ“šã€è¨­å®šç‹€æ…‹ç­‰çš„è¨ªå•æ¬Šé™
   */
  const dataStore = useDataStore();

  // ==================== ğŸ“Š éŸ¿æ‡‰å¼ç‹€æ…‹å®šç¾© (Reactive State Definition) ====================

  /**
   * ğŸ“‘ ç•¶å‰ä½œç”¨ä¸­çš„åœ–å±¤åˆ†é  (Active Layer Tab)
   * è¿½è¹¤ä½¿ç”¨è€…ç•¶å‰é¸ä¸­çš„åœ–å±¤åˆ†é ï¼Œç”¨æ–¼æ§åˆ¶è³‡è¨Šå…§å®¹é¡¯ç¤º
   *
   * @type {Ref<string|null>}
   * @description
   * - å­˜å„²ç•¶å‰é¸ä¸­åœ–å±¤çš„ layerId
   * - null è¡¨ç¤ºæ²’æœ‰é¸ä¸­ä»»ä½•åœ–å±¤
   * - ç”¨æ–¼æ§åˆ¶å“ªå€‹åœ–å±¤çš„è³‡è¨Šéœ€è¦é¡¯ç¤º
   */
  const activeLayerTab = ref(null);

  /**
   * ğŸ“Š åˆ†æçµæœ (Analysis Results)
   * å­˜å„²åœ–å±¤åˆ†æçš„çµæœæ•¸æ“šï¼Œç”¨æ–¼é¡¯ç¤ºçµ±è¨ˆè³‡è¨Š
   *
   * @type {Ref<Object|null>}
   * @description
   * - åŒ…å«åœ–å±¤çµ±è¨ˆæ•¸æ“šçš„ç‰©ä»¶
   * - null è¡¨ç¤ºå°šæœªè¼‰å…¥åˆ†æçµæœ
   * - çµæ§‹åŒ…å« layerName, timestamp, statistics ç­‰æ¬„ä½
   */
  const analysisResults = ref(null);

  /**
   * ğŸ”„ åˆ†æè¼‰å…¥ç‹€æ…‹ (Analysis Loading State)
   * è¿½è¹¤åˆ†æéç¨‹çš„è¼‰å…¥ç‹€æ…‹ï¼Œç”¨æ–¼é¡¯ç¤ºè¼‰å…¥æŒ‡ç¤ºå™¨
   *
   * @type {Ref<boolean>}
   * @description
   * - true: æ­£åœ¨è¼‰å…¥åˆ†æçµæœï¼Œé¡¯ç¤ºè¼‰å…¥å‹•ç•«
   * - false: è¼‰å…¥å®Œæˆï¼Œé¡¯ç¤ºåˆ†æçµæœæˆ–éŒ¯èª¤è¨Šæ¯
   */
  const isLoadingAnalysis = ref(false);

  // ==================== ğŸ“Š è¨ˆç®—å±¬æ€§å®šç¾© (Computed Properties Definition) ====================

  /**
   * ç²å–æ‰€æœ‰å¯è¦‹ä¸”æœ‰è³‡æ–™çš„åœ–å±¤ (Get All Visible Layers with Data)
   * å¾å…¨åŸŸç‹€æ…‹ä¸­ç¯©é¸å‡ºå¯è¦‹ä¸”å·²è¼‰å…¥è³‡æ–™çš„åœ–å±¤
   *
   * @type {ComputedRef<Array>}
   * @description
   * - è¿”å›åŒ…å«æ‰€æœ‰å¯è¦‹åœ–å±¤çš„é™£åˆ—
   * - ç”¨æ–¼ç”Ÿæˆåˆ†é å°èˆªå’Œåœ–å±¤åˆ‡æ›åŠŸèƒ½
   * - æ¯å€‹åœ–å±¤åŒ…å« layerId, layerName, dataTableData ç­‰å±¬æ€§
   * - è‡ªå‹•éŸ¿æ‡‰å…¨åŸŸç‹€æ…‹è®ŠåŒ–
   *
   * @returns {Array<Object>} å¯è¦‹åœ–å±¤é™£åˆ—
   */
  const visibleLayers = computed(() => {
    // å¾æ•¸æ“šå­˜å„²ä¸­ç²å–æ‰€æœ‰åœ–å±¤
    const allLayers = dataStore.getAllLayers();
    // ç¯©é¸å‡ºå¯è¦‹çš„åœ–å±¤ï¼ˆlayer.visible === trueï¼‰
    return allLayers.filter((layer) => layer.visible);
  });

  // ==================== ğŸ¯ æ ¸å¿ƒåŠŸèƒ½å‡½æ•¸ (Core Function Functions) ====================

  /**
   * ğŸ“‘ è¨­å®šä½œç”¨ä¸­åœ–å±¤åˆ†é  (Set Active Layer Tab)
   * åˆ‡æ›åˆ°æŒ‡å®šçš„åœ–å±¤åˆ†é ä¸¦è§¸ç™¼ç›¸é—œçš„è³‡è¨Šè¼‰å…¥
   *
   * @param {string} layerId - è¦åˆ‡æ›åˆ°çš„åœ–å±¤ ID
   * @description æ›´æ–° activeLayerTab ç‹€æ…‹ï¼Œè§¸ç™¼åœ–å±¤è³‡è¨Šè¼‰å…¥
   */
  const setActiveLayerTab = (layerId) => {
    activeLayerTab.value = layerId;
  };

  /**
   * ğŸ“Š å–å¾—åœ–å±¤å®Œæ•´æ¨™é¡Œ (åŒ…å«ç¾¤çµ„åç¨±) (Get Layer Full Title with Group Name)
   * çµ„åˆç¾¤çµ„åç¨±å’Œåœ–å±¤åç¨±ï¼Œå½¢æˆå®Œæ•´çš„åœ–å±¤æ¨™é¡Œ
   *
   * @param {Object} layer - åœ–å±¤ç‰©ä»¶
   * @returns {Object} åŒ…å« groupName å’Œ layerName çš„ç‰©ä»¶
   * @description
   * - å¾ dataStore ä¸­æŸ¥æ‰¾å°æ‡‰çš„ç¾¤çµ„åç¨±
   * - è¿”å›çµæ§‹åŒ–çš„æ¨™é¡Œè³‡è¨Š
   * - è™•ç†åœ–å±¤ä¸å­˜åœ¨çš„æƒ…æ³
   */
  const getLayerFullTitle = (layer) => {
    if (!layer) return { groupName: null, layerName: 'æœªçŸ¥åœ–å±¤' };
    const groupName = dataStore.findGroupNameByLayerId(layer.layerId);
    return {
      groupName: groupName,
      layerName: layer.layerName,
    };
  };

  /**
   * ğŸ¨ æ ¼å¼åŒ–é¡¯ç¤ºå€¼ (Format Display Value)
   * æ ¹æ“šå€¼çš„é¡å‹é€²è¡Œé©ç•¶çš„æ ¼å¼åŒ–è™•ç†ï¼Œé¿å…é¡¯ç¤º [object Object]
   *
   * @param {any} value - è¦æ ¼å¼åŒ–çš„å€¼
   * @returns {string} æ ¼å¼åŒ–å¾Œçš„é¡¯ç¤ºå€¼
   * @description
   * - è™•ç†åŸºæœ¬é¡å‹ï¼šç›´æ¥è¿”å›
   * - è™•ç†é™£åˆ—ï¼šæ ¼å¼åŒ–é™£åˆ—å…§å®¹
   * - è™•ç†ç‰©ä»¶ï¼šè½‰æ›ç‚º JSON å­—ä¸²æˆ–é¡¯ç¤ºç‰©ä»¶å±¬æ€§
   * - è™•ç† null/undefinedï¼šé¡¯ç¤ºé©ç•¶çš„é è¨­å€¼
   */
  const formatDisplayValue = (value) => {
    // è™•ç† null æˆ– undefined
    if (value === null || value === undefined) {
      return 'ç„¡è³‡æ–™';
    }

    // è™•ç†åŸºæœ¬é¡å‹
    if (typeof value === 'string' || typeof value === 'number' || typeof value === 'boolean') {
      return String(value);
    }

    // è™•ç†é™£åˆ—
    if (Array.isArray(value)) {
      if (value.length === 0) {
        return 'ç©ºé™£åˆ—';
      }

      // æª¢æŸ¥é™£åˆ—å…§å®¹æ˜¯å¦ç‚ºç‰©ä»¶
      const hasObjects = value.some((item) => typeof item === 'object' && item !== null);

      if (hasObjects) {
        // å¦‚æœæ˜¯ç‰©ä»¶é™£åˆ—ï¼Œé¡¯ç¤ºç‰©ä»¶çš„ä¸»è¦å±¬æ€§
        return value
          .map((item, index) => {
            if (typeof item === 'object' && item !== null) {
              // å˜—è©¦é¡¯ç¤ºç‰©ä»¶çš„ä¸»è¦å±¬æ€§
              const keys = Object.keys(item);
              if (keys.length > 0) {
                const mainKey = keys[0];
                return `${index + 1}: ${mainKey}=${item[mainKey]}`;
              }
              return `${index + 1}: ç‰©ä»¶`;
            }
            return String(item);
          })
          .join(', ');
      } else {
        // åŸºæœ¬é¡å‹é™£åˆ—ï¼Œç›´æ¥é€£æ¥
        return value.join(', ');
      }
    }

    // è™•ç†ç‰©ä»¶
    if (typeof value === 'object') {
      const keys = Object.keys(value);
      if (keys.length === 0) {
        return 'ç©ºç‰©ä»¶';
      }

      // å¦‚æœç‰©ä»¶å±¬æ€§è¼ƒå°‘ï¼Œé¡¯ç¤ºæ‰€æœ‰å±¬æ€§
      if (keys.length <= 3) {
        return keys.map((key) => `${key}: ${value[key]}`).join(', ');
      }

      // å¦‚æœç‰©ä»¶å±¬æ€§è¼ƒå¤šï¼Œé¡¯ç¤ºå‰å¹¾å€‹å±¬æ€§
      const previewKeys = keys.slice(0, 2);
      return (
        previewKeys.map((key) => `${key}: ${value[key]}`).join(', ') +
        ` ... (å…± ${keys.length} å€‹å±¬æ€§)`
      );
    }

    // å…¶ä»–é¡å‹ï¼Œè½‰æ›ç‚ºå­—ä¸²
    return String(value);
  };

  /**
   * ğŸ“Š å–å¾—ç•¶å‰åœ–å±¤è³‡è¨Šæ•¸æ“š (Get Current Layer Info Data)
   * ç²å–ç•¶å‰é¸ä¸­åœ–å±¤çš„ layerInfoData
   *
   * @returns {Object|null} ç•¶å‰åœ–å±¤çš„è³‡è¨Šæ•¸æ“š
   * @description
   * - æŸ¥æ‰¾ç•¶å‰é¸ä¸­çš„åœ–å±¤
   * - è¿”å› layerInfoData å°è±¡
   * - è™•ç†åœ–å±¤ä¸å­˜åœ¨æˆ–ç„¡è³‡æ–™çš„æƒ…æ³
   */
  const getCurrentLayerInfoData = () => {
    if (!activeLayerTab.value) return null;
    const currentLayer = visibleLayers.value.find(
      (layer) => layer.layerId === activeLayerTab.value
    );
    return currentLayer ? currentLayer.layerInfoData || null : null;
  };

  /**
   * å–å¾—ç›®å‰åœ–å±¤çš„ layerInfoDataï¼ˆéæ¿¾æ‰ gridX/gridYï¼Œé¿å…èˆ‡æœ‰æ•ˆå€¼é‡è¦†é¡¯ç¤ºï¼‰
   */
  const currentLayerInfoEntries = computed(() => {
    const data = getCurrentLayerInfoData();
    if (!data) return [];
    return Object.entries(data).filter(([key]) => key !== 'gridX' && key !== 'gridY');
  });

  /**
   * å–å¾—ç•¶å‰åœ–å±¤åœ¨é‡ç¹ªå¾Œçš„å¯¦éš›ç¶²æ ¼ç‹€æ…‹ï¼ˆå¯è¦‹è¡Œåˆ—èˆ‡å–®å…ƒå°ºå¯¸ï¼‰
   */
  const getComputedGridState = () => {
    if (!activeLayerTab.value) return null;
    const layerState = dataStore.layerStates?.[activeLayerTab.value];
    return layerState && layerState.computedGridState ? layerState.computedGridState : null;
  };

  /**
   * ğŸ“ è¨ˆç®—ç¶²æ ¼å¯¬åº¦ (Calculate Grid Width)
   * æ ¹æ“š D3js å®¹å™¨å°ºå¯¸å’Œç¶²æ ¼é…ç½®è¨ˆç®—æ¯å€‹ç¶²æ ¼å–®å…ƒçš„å¯¬åº¦
   *
   * @returns {number} ç¶²æ ¼å–®å…ƒå¯¬åº¦ï¼ˆåƒç´ ï¼‰
   * @description
   * - å¾ç•¶å‰åœ–å±¤çš„ layerInfoData æˆ– processedJsonData ä¸­ç²å–ç¶²æ ¼é…ç½®
   * - æ ¹æ“š D3js å®¹å™¨å°ºå¯¸å’Œç¶²æ ¼ X æ–¹å‘æ•¸é‡è¨ˆç®—å–®å…ƒå¯¬åº¦
   * - å¦‚æœæ²’æœ‰ç¶²æ ¼é…ç½®å‰‡è¿”å› 0
   */
  const getGridWidth = () => {
    const layerInfoData = getCurrentLayerInfoData();
    const currentLayer = visibleLayers.value.find(
      (layer) => layer.layerId === activeLayerTab.value
    );

    // å„ªå…ˆä½¿ç”¨é‡ç¹ªå¾Œè¨ˆç®—å‡ºçš„ cellWidth
    const computedState = getComputedGridState();
    if (computedState && computedState.cellWidth > 0) {
      return computedState.cellWidth;
    }

    if (!dataStore.d3jsDimensions.width) {
      return 0;
    }

    // å˜—è©¦å¾ä¸åŒä¾†æºç²å–ç¶²æ ¼é…ç½®
    let gridX = null;

    // 1. å¾ layerInfoData ç²å–
    if (layerInfoData && layerInfoData.gridX) {
      gridX = layerInfoData.gridX;
    }
    // 2. å¾ processedJsonData ç²å–
    else if (
      currentLayer &&
      currentLayer.processedJsonData &&
      currentLayer.processedJsonData.gridX
    ) {
      gridX = currentLayer.processedJsonData.gridX;
    }
    // 3. å¾ dashboardData ç²å–
    else if (currentLayer && currentLayer.dashboardData && currentLayer.dashboardData.gridX) {
      gridX = currentLayer.dashboardData.gridX;
    }
    // 4. å¾å°åŒ—æ·é‹ç­‰ç¤ºæ„åœ–æ•¸æ“šè¨ˆç®—ç¶²æ ¼å°ºå¯¸
    else if (
      currentLayer &&
      currentLayer.processedJsonData &&
      Array.isArray(currentLayer.processedJsonData) &&
      currentLayer.processedJsonData.length > 0 &&
      currentLayer.processedJsonData[0].nodes
    ) {
      // é€™æ˜¯å°åŒ—æ·é‹ç­‰ç¤ºæ„åœ–æ•¸æ“šï¼Œéœ€è¦å¾ç¯€é»åº§æ¨™è¨ˆç®—ç¶²æ ¼å°ºå¯¸
      const allXCoords = [];

      currentLayer.processedJsonData.forEach((line) => {
        if (line.nodes && Array.isArray(line.nodes)) {
          line.nodes.forEach((node) => {
            if (node.coord && typeof node.coord.x === 'number') {
              allXCoords.push(node.coord.x);
            }
          });
        }
      });

      if (allXCoords.length > 0) {
        const minX = Math.min(...allXCoords);
        const maxX = Math.max(...allXCoords);
        gridX = maxX - minX + 1; // ç¶²æ ¼å¯¬åº¦ = æœ€å¤§x - æœ€å°x + 1
        console.log('ğŸ” å¾å°åŒ—æ·é‹æ•¸æ“šè¨ˆç®—ç¶²æ ¼å¯¬åº¦:', {
          minX,
          maxX,
          gridX,
          allXCoords: allXCoords.slice(0, 10),
        });
      }
    }

    if (!gridX) {
      console.log('ğŸ” Grid Width Debug: æ‰¾ä¸åˆ° gridX é…ç½®', {
        layerInfoData,
        currentLayer: currentLayer
          ? {
              processedJsonData: currentLayer.processedJsonData,
              dashboardData: currentLayer.dashboardData,
            }
          : null,
      });

      // å¦‚æœæ˜¯éç¶²æ ¼åœ–å±¤ï¼Œè¿”å› 0 è¡¨ç¤ºä¸é©ç”¨
      if (currentLayer && !currentLayer.isGridSchematic) {
        console.log('ğŸ” éç¶²æ ¼åœ–å±¤ï¼ŒGrid Width ä¸é©ç”¨');
        return 0;
      }

      return 0;
    }

    // è¨ˆç®—ç¶²æ ¼å–®å…ƒå¯¬åº¦ï¼šå®¹å™¨å¯¬åº¦ / ç¶²æ ¼ X æ–¹å‘æ•¸é‡
    const containerWidth = dataStore.d3jsDimensions.width;
    const cellWidth = Math.floor(containerWidth / gridX);

    console.log('ğŸ” Grid Width Debug:', {
      containerWidth,
      gridX,
      cellWidth,
    });

    return cellWidth;
  };

  /**
   * ğŸ“ è¨ˆç®—ç¶²æ ¼é«˜åº¦ (Calculate Grid Height)
   * æ ¹æ“š D3js å®¹å™¨å°ºå¯¸å’Œç¶²æ ¼é…ç½®è¨ˆç®—æ¯å€‹ç¶²æ ¼å–®å…ƒçš„é«˜åº¦
   *
   * @returns {number} ç¶²æ ¼å–®å…ƒé«˜åº¦ï¼ˆåƒç´ ï¼‰
   * @description
   * - å¾ç•¶å‰åœ–å±¤çš„ layerInfoData æˆ– processedJsonData ä¸­ç²å–ç¶²æ ¼é…ç½®
   * - æ ¹æ“š D3js å®¹å™¨å°ºå¯¸å’Œç¶²æ ¼ Y æ–¹å‘æ•¸é‡è¨ˆç®—å–®å…ƒé«˜åº¦
   * - å¦‚æœæ²’æœ‰ç¶²æ ¼é…ç½®å‰‡è¿”å› 0
   */
  const getGridHeight = () => {
    const layerInfoData = getCurrentLayerInfoData();
    const currentLayer = visibleLayers.value.find(
      (layer) => layer.layerId === activeLayerTab.value
    );

    // å„ªå…ˆä½¿ç”¨é‡ç¹ªå¾Œè¨ˆç®—å‡ºçš„ cellHeight
    const computedState = getComputedGridState();
    if (computedState && computedState.cellHeight > 0) {
      return computedState.cellHeight;
    }

    if (!dataStore.d3jsDimensions.height) {
      return 0;
    }

    // å˜—è©¦å¾ä¸åŒä¾†æºç²å–ç¶²æ ¼é…ç½®
    let gridY = null;

    // 1. å¾ layerInfoData ç²å–
    if (layerInfoData && layerInfoData.gridY) {
      gridY = layerInfoData.gridY;
    }
    // 2. å¾ processedJsonData ç²å–
    else if (
      currentLayer &&
      currentLayer.processedJsonData &&
      currentLayer.processedJsonData.gridY
    ) {
      gridY = currentLayer.processedJsonData.gridY;
    }
    // 3. å¾ dashboardData ç²å–
    else if (currentLayer && currentLayer.dashboardData && currentLayer.dashboardData.gridY) {
      gridY = currentLayer.dashboardData.gridY;
    }
    // 4. å¾å°åŒ—æ·é‹ç­‰ç¤ºæ„åœ–æ•¸æ“šè¨ˆç®—ç¶²æ ¼å°ºå¯¸
    else if (
      currentLayer &&
      currentLayer.processedJsonData &&
      Array.isArray(currentLayer.processedJsonData) &&
      currentLayer.processedJsonData.length > 0 &&
      currentLayer.processedJsonData[0].nodes
    ) {
      // é€™æ˜¯å°åŒ—æ·é‹ç­‰ç¤ºæ„åœ–æ•¸æ“šï¼Œéœ€è¦å¾ç¯€é»åº§æ¨™è¨ˆç®—ç¶²æ ¼å°ºå¯¸
      const allYCoords = [];

      currentLayer.processedJsonData.forEach((line) => {
        if (line.nodes && Array.isArray(line.nodes)) {
          line.nodes.forEach((node) => {
            if (node.coord && typeof node.coord.y === 'number') {
              allYCoords.push(node.coord.y);
            }
          });
        }
      });

      if (allYCoords.length > 0) {
        const minY = Math.min(...allYCoords);
        const maxY = Math.max(...allYCoords);
        gridY = maxY - minY + 1; // ç¶²æ ¼é«˜åº¦ = æœ€å¤§y - æœ€å°y + 1
        console.log('ğŸ” å¾å°åŒ—æ·é‹æ•¸æ“šè¨ˆç®—ç¶²æ ¼é«˜åº¦:', {
          minY,
          maxY,
          gridY,
          allYCoords: allYCoords.slice(0, 10),
        });
      }
    }

    if (!gridY) {
      console.log('ğŸ” Grid Height Debug: æ‰¾ä¸åˆ° gridY é…ç½®', {
        layerInfoData,
        currentLayer: currentLayer
          ? {
              processedJsonData: currentLayer.processedJsonData,
              dashboardData: currentLayer.dashboardData,
            }
          : null,
      });

      // å¦‚æœæ˜¯éç¶²æ ¼åœ–å±¤ï¼Œè¿”å› 0 è¡¨ç¤ºä¸é©ç”¨
      if (currentLayer && !currentLayer.isGridSchematic) {
        console.log('ğŸ” éç¶²æ ¼åœ–å±¤ï¼ŒGrid Height ä¸é©ç”¨');
        return 0;
      }

      return 0;
    }

    // è¨ˆç®—ç¶²æ ¼å–®å…ƒé«˜åº¦ï¼šå®¹å™¨é«˜åº¦ / ç¶²æ ¼ Y æ–¹å‘æ•¸é‡
    const containerHeight = dataStore.d3jsDimensions.height;
    const cellHeight = Math.floor(containerHeight / gridY);

    console.log('ğŸ” Grid Height Debug:', {
      containerHeight,
      gridY,
      cellHeight,
    });

    return cellHeight;
  };

  /**
   * å–å¾—æœ‰æ•ˆçš„ Grid Xï¼ˆé¡¯ç¤ºä¸­çš„æ¬„æ•¸ï¼‰
   */
  const getEffectiveGridX = () => {
    const computedState = getComputedGridState();
    if (computedState && computedState.visibleX) return computedState.visibleX;

    // å¾Œå‚™ï¼šæ²¿ç”¨åŸæœ¬çš„ gridX æ¨å°é‚è¼¯
    const layerInfoData = getCurrentLayerInfoData();
    const currentLayer = visibleLayers.value.find(
      (layer) => layer.layerId === activeLayerTab.value
    );

    let gridX = null;
    if (layerInfoData && layerInfoData.gridX) gridX = layerInfoData.gridX;
    else if (currentLayer && currentLayer.processedJsonData && currentLayer.processedJsonData.gridX)
      gridX = currentLayer.processedJsonData.gridX;
    else if (currentLayer && currentLayer.dashboardData && currentLayer.dashboardData.gridX)
      gridX = currentLayer.dashboardData.gridX;
    return gridX || 0;
  };

  /**
   * å–å¾—æœ‰æ•ˆçš„ Grid Yï¼ˆé¡¯ç¤ºä¸­çš„åˆ—æ•¸ï¼‰
   */
  const getEffectiveGridY = () => {
    const computedState = getComputedGridState();
    if (computedState && computedState.visibleY) return computedState.visibleY;

    // å¾Œå‚™ï¼šæ²¿ç”¨åŸæœ¬çš„ gridY æ¨å°é‚è¼¯
    const layerInfoData = getCurrentLayerInfoData();
    const currentLayer = visibleLayers.value.find(
      (layer) => layer.layerId === activeLayerTab.value
    );

    let gridY = null;
    if (layerInfoData && layerInfoData.gridY) gridY = layerInfoData.gridY;
    else if (currentLayer && currentLayer.processedJsonData && currentLayer.processedJsonData.gridY)
      gridY = currentLayer.processedJsonData.gridY;
    else if (currentLayer && currentLayer.dashboardData && currentLayer.dashboardData.gridY)
      gridY = currentLayer.dashboardData.gridY;
    return gridY || 0;
  };

  // ==================== ğŸ‘€ éŸ¿æ‡‰å¼ç›£è½å™¨ (Reactive Watchers) ====================

  /**
   * è¨˜éŒ„ä¸Šä¸€æ¬¡çš„åœ–å±¤åˆ—è¡¨ç”¨æ–¼æ¯”è¼ƒè®ŠåŒ–
   * ç”¨æ–¼åµæ¸¬æ–°å¢çš„åœ–å±¤ä¸¦è‡ªå‹•åˆ‡æ›åˆ°æœ€æ–°åœ–å±¤
   */
  const previousLayers = ref([]);

  /**
   * ğŸ‘€ ç›£è½å¯è¦‹åœ–å±¤è®ŠåŒ–ï¼Œè‡ªå‹•åˆ‡æ›åˆ°æ–°é–‹å•Ÿçš„åœ–å±¤åˆ†é 
   * ç•¶åœ–å±¤å¯è¦‹æ€§ç™¼ç”Ÿè®ŠåŒ–æ™‚ï¼Œè‡ªå‹•èª¿æ•´ç•¶å‰é¸ä¸­çš„åˆ†é 
   *
   * @description ä¸»è¦é‚è¼¯ï¼š
   * - åµæ¸¬æ–°å¢çš„åœ–å±¤ä¸¦è‡ªå‹•åˆ‡æ›åˆ°æœ€æ–°åœ–å±¤
   * - è™•ç†åœ–å±¤è¢«éš±è—æ™‚çš„åˆ†é åˆ‡æ›
   * - ç•¶æ²’æœ‰å¯è¦‹åœ–å±¤æ™‚æ¸…é™¤é¸ä¸­ç‹€æ…‹
   * - ç¶­è­·åœ–å±¤åˆ—è¡¨çš„æ­·å²è¨˜éŒ„
   */
  watch(
    () => visibleLayers.value,
    (newLayers) => {
      // å¦‚æœæ²’æœ‰å¯è¦‹åœ–å±¤ï¼Œæ¸…é™¤é¸ä¸­çš„åˆ†é å’Œåˆ†æçµæœ
      if (newLayers.length === 0) {
        activeLayerTab.value = null;
        analysisResults.value = null;
        previousLayers.value = [];
        return;
      }

      // æ‰¾å‡ºæ–°å¢çš„åœ–å±¤ï¼ˆæ¯”è¼ƒæ–°èˆŠåœ–å±¤åˆ—è¡¨ï¼‰
      const previousLayerIds = previousLayers.value.map((layer) => layer.layerId);
      const newLayerIds = newLayers.map((layer) => layer.layerId);
      const addedLayerIds = newLayerIds.filter((id) => !previousLayerIds.includes(id));

      // å¦‚æœæœ‰æ–°å¢çš„åœ–å±¤ï¼Œè‡ªå‹•åˆ‡æ›åˆ°æœ€æ–°æ–°å¢çš„åœ–å±¤
      if (addedLayerIds.length > 0) {
        const newestAddedLayerId = addedLayerIds[addedLayerIds.length - 1];
        activeLayerTab.value = newestAddedLayerId;
      }
      // å¦‚æœç•¶å‰æ²’æœ‰é¸ä¸­åˆ†é ï¼Œæˆ–é¸ä¸­çš„åˆ†é ä¸åœ¨å¯è¦‹åˆ—è¡¨ä¸­ï¼Œé¸ä¸­ç¬¬ä¸€å€‹
      else if (
        !activeLayerTab.value ||
        !newLayers.find((layer) => layer.layerId === activeLayerTab.value)
      ) {
        activeLayerTab.value = newLayers[0].layerId;
      }

      // æ›´æ–°è¨˜éŒ„çš„åœ–å±¤åˆ—è¡¨
      previousLayers.value = [...newLayers];
    },
    { deep: true, immediate: true }
  );

  // ==================== ğŸ“Š è³‡æ–™è™•ç†å‡½æ•¸ (Data Processing Functions) ====================

  /**
   * ğŸ“Š è¼‰å…¥åœ–å±¤åŸºæœ¬è³‡è¨Š (Load Layer Basic Information)
   * åˆ†ææŒ‡å®šåœ–å±¤çš„è³‡æ–™ä¸¦è¨ˆç®—çµ±è¨ˆè³‡è¨Š
   *
   * @param {Object} layer - è¦è¼‰å…¥è³‡è¨Šçš„åœ–å±¤ç‰©ä»¶
   * @description ä¸»è¦åŠŸèƒ½ï¼š
   * - åˆ†æåœ–å±¤ä¸­çš„ features è³‡æ–™
   * - è¨ˆç®—ç¸½æ•¸é‡ã€ç¸½äººå£æ•¸ã€å¹³å‡å€¼ç­‰çµ±è¨ˆæŒ‡æ¨™
   * - æä¾›è¼‰å…¥ç‹€æ…‹æŒ‡ç¤ºå’ŒéŒ¯èª¤è™•ç†
   * - å°‡çµæœå­˜å„²åˆ° analysisResults ä¸­
   */
  const loadLayerInfo = async (layer) => {
    if (!layer || !layer.processedJsonData) {
      console.warn('ç„¡æ³•è¼‰å…¥è³‡è¨Šï¼šåœ–å±¤æ•¸æ“šä¸å­˜åœ¨');
      return;
    }

    isLoadingAnalysis.value = true;

    try {
      // æ¨¡æ“¬è¼‰å…¥éç¨‹ï¼Œæä¾›è¦–è¦ºåé¥‹
      await new Promise((resolve) => setTimeout(resolve, 500));

      const features = layer.processedJsonData.features;

      // è¨ˆç®—åŸºæœ¬çµ±è¨ˆè³‡è¨Š
      const stats = {
        totalFeatures: features.length,
        totalPopulation: features.reduce((sum, f) => sum + (f.properties.P_CNT || 0), 0),
        totalCount: features.reduce((sum, f) => sum + (f.properties.count || 0), 0),
        avgPopulation: 0,
        avgCount: 0,
      };

      // è¨ˆç®—å¹³å‡å€¼ï¼ˆé¿å…é™¤é›¶éŒ¯èª¤ï¼‰
      if (stats.totalFeatures > 0) {
        stats.avgPopulation = stats.totalPopulation / stats.totalFeatures;
        stats.avgCount = stats.totalCount / stats.totalFeatures;
      }

      // å„²å­˜åˆ†æçµæœ
      analysisResults.value = {
        layerName: layer.layerName,
        timestamp: new Date().toLocaleString(),
        statistics: stats,
      };

      console.log('åœ–å±¤è³‡è¨Šè¼‰å…¥å®Œæˆ:', analysisResults.value);
    } catch (error) {
      console.error('è¼‰å…¥åœ–å±¤è³‡è¨Šå¤±æ•—:', error);
      // å„²å­˜éŒ¯èª¤è³‡è¨Šä»¥ä¾›é¡¯ç¤º
      analysisResults.value = {
        error: 'è¼‰å…¥éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤',
        details: error.message,
      };
    } finally {
      isLoadingAnalysis.value = false;
    }
  };

  /**
   * ğŸ‘€ ç›£è½ç•¶å‰é¸ä¸­çš„åœ–å±¤è®ŠåŒ–ï¼Œè‡ªå‹•åŸ·è¡Œè³‡è¨Šè¼‰å…¥
   * ç•¶ activeLayerTab ç™¼ç”Ÿè®ŠåŒ–æ™‚ï¼Œè‡ªå‹•è¼‰å…¥å°æ‡‰åœ–å±¤çš„è³‡è¨Š
   *
   * @description ä¸»è¦é‚è¼¯ï¼š
   * - ç•¶åˆ‡æ›åˆ°æ–°åœ–å±¤æ™‚ï¼Œè‡ªå‹•è¼‰å…¥è©²åœ–å±¤çš„è³‡è¨Š
   * - ç•¶æ¸…é™¤é¸ä¸­ç‹€æ…‹æ™‚ï¼Œæ¸…é™¤åˆ†æçµæœ
   * - ç¢ºä¿åœ–å±¤è³‡è¨Šèˆ‡ç•¶å‰é¸ä¸­ç‹€æ…‹ä¿æŒåŒæ­¥
   */
  watch(
    () => activeLayerTab.value,
    (newLayerId) => {
      if (newLayerId) {
        const layer = dataStore.findLayerById(newLayerId);
        if (layer && layer.processedJsonData) {
          loadLayerInfo(layer);
        }
      } else {
        analysisResults.value = null;
      }
    },
    { immediate: true }
  );

  // ==================== ğŸš€ ç”Ÿå‘½é€±æœŸé‰¤å­ (Lifecycle Hooks) ====================

  /**
   * ğŸš€ çµ„ä»¶æ›è¼‰äº‹ä»¶ (Component Mounted Event)
   * çµ„ä»¶åˆå§‹åŒ–å®Œæˆå¾Œçš„è¨­å®šå·¥ä½œ
   *
   * @description ä¸»è¦å·¥ä½œï¼š
   * - åˆå§‹åŒ–ç¬¬ä¸€å€‹å¯è¦‹åœ–å±¤ç‚ºä½œç”¨ä¸­åˆ†é 
   * - ç¢ºä¿çµ„ä»¶è¼‰å…¥å¾Œæœ‰æ­£ç¢ºçš„åˆå§‹ç‹€æ…‹
   */
  onMounted(() => {
    // åˆå§‹åŒ–ç¬¬ä¸€å€‹å¯è¦‹åœ–å±¤ç‚ºä½œç”¨ä¸­åˆ†é 
    if (visibleLayers.value.length > 0 && !activeLayerTab.value) {
      activeLayerTab.value = visibleLayers.value[0].layerId;
    }
  });
</script>

<template>
  <!-- ğŸ“Š åœ–å±¤è³‡è¨Šåˆ†é è¦–åœ–çµ„ä»¶ -->
  <div class="d-flex flex-column my-bgcolor-gray-200 h-100">
    <!-- ğŸ“‘ åœ–å±¤åˆ†é å°èˆª -->
    <div v-if="visibleLayers.length > 0" class="">
      <ul class="nav nav-tabs nav-fill">
        <li
          v-for="layer in visibleLayers"
          :key="layer.layerId"
          class="nav-item d-flex flex-column align-items-center"
        >
          <!-- tabæŒ‰éˆ• -->
          <div
            class="btn nav-link rounded-0 border-0 position-relative d-flex align-items-center justify-content-center my-bgcolor-gray-200"
            :class="{
              active: activeLayerTab === layer.layerId,
            }"
            @click="setActiveLayerTab(layer.layerId)"
          >
            <span>
              <span v-if="getLayerFullTitle(layer).groupName" class="my-title-xs-gray"
                >{{ getLayerFullTitle(layer).groupName }} -
              </span>
              <span class="my-title-sm-black">{{ getLayerFullTitle(layer).layerName }}</span>
            </span>
          </div>
          <div class="w-100" :class="`my-bgcolor-${layer.colorName}`" style="min-height: 4px"></div>
        </li>
      </ul>
    </div>

    <!-- æœ‰é–‹å•Ÿåœ–å±¤æ™‚çš„å…§å®¹ -->
    <div v-if="visibleLayers.length > 0" class="my-bgcolor-white h-100">
      <div>
        <div class="p-3">
          <!-- è¼‰å…¥ç‹€æ…‹å€åŸŸ -->
          <div v-if="isLoadingAnalysis" class="pb-2">
            <div class="my-title-xs-gray pb-1">è¼‰å…¥ç‹€æ…‹</div>
            <div class="my-content-sm-black pb-1">
              <span v-html="getIconHtml('spinner', 'fa-spin me-2')"></span>
              æ­£åœ¨è¼‰å…¥åœ–å±¤è³‡è¨Š...
            </div>
          </div>

          <!-- åœ–å±¤è³‡è¨Šé¡¯ç¤ºå€åŸŸ -->
          <template v-if="visibleLayers.length > 0 && getCurrentLayerInfoData()">
            <!-- é¡¯ç¤º layerInfoData çš„æ‰€æœ‰å…§å®¹ -->
            <div v-for="[key, value] in currentLayerInfoEntries" :key="key" class="pb-2">
              <div class="my-title-xs-gray pb-1">{{ key }}</div>
              <div class="my-content-sm-black pb-1">
                {{ formatDisplayValue(value) }}
              </div>
            </div>

            <!-- D3jsTab ç¹ªè£½ç¯„åœå°ºå¯¸ -->
            <DetailItem label="D3js Width" :value="dataStore.d3jsDimensions.width + 'px'" />
            <DetailItem label="D3js Height" :value="dataStore.d3jsDimensions.height + 'px'" />

            <!-- Grid ç¶²æ ¼å°ºå¯¸ -->
            <DetailItem
              label="Grid Width"
              :value="getGridWidth() > 0 ? getGridWidth() + 'px' : 'N/A'"
            />
            <DetailItem
              label="Grid Height"
              :value="getGridHeight() > 0 ? getGridHeight() + 'px' : 'N/A'"
            />

            <!-- Grid ç¶­åº¦ï¼ˆé¡¯ç¤ºä¸­çš„ gridX / gridYï¼‰ -->
            <DetailItem
              label="gridX"
              :value="getEffectiveGridX() > 0 ? getEffectiveGridX() : 'N/A'"
            />
            <DetailItem
              label="gridY"
              :value="getEffectiveGridY() > 0 ? getEffectiveGridY() : 'N/A'"
            />
          </template>

          <!-- éŒ¯èª¤é¡¯ç¤º -->
          <div v-else-if="analysisResults && analysisResults.error" class="pb-2">
            <div class="my-title-xs-gray pb-1">è¼‰å…¥éŒ¯èª¤</div>
            <div class="my-content-sm-black pb-1">{{ analysisResults.error }}</div>
            <div v-if="analysisResults.details" class="my-content-xs-gray pb-1">
              è©³ç´°ä¿¡æ¯ï¼š{{ analysisResults.details }}
            </div>
          </div>

          <!-- åˆå§‹ç‹€æ…‹ -->
          <div v-else-if="!isLoadingAnalysis" class="pb-2">
            <div class="my-title-xs-gray pb-1">è¼‰å…¥ç‹€æ…‹</div>
            <div class="my-content-sm-black pb-1">ç­‰å¾…åœ–å±¤æ•¸æ“šè¼‰å…¥...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- æ²’æœ‰é–‹å•Ÿåœ–å±¤æ™‚çš„ç©ºç‹€æ…‹ -->
    <div v-else class="flex-grow-1 d-flex align-items-center justify-content-center">
      <div class="text-center">
        <div class="my-title-md-gray p-3">æ²’æœ‰é–‹å•Ÿçš„åœ–å±¤</div>
      </div>
    </div>
  </div>
</template>

<style scoped></style>
