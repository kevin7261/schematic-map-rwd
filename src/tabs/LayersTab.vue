<script>
  /**
   * ğŸ“‹ LayersTab.vue - åœ–å±¤åˆ—è¡¨åˆ†é çµ„ä»¶ (Layers Tab Component)
   *
   * é€™æ˜¯ä¸€å€‹å°ˆé–€ç”¨æ–¼åœ–å±¤ç®¡ç†çš„åˆ†é çµ„ä»¶ï¼Œæä¾›å®Œæ•´çš„åœ–å±¤æ§åˆ¶ä»‹é¢ã€‚
   * è©²çµ„ä»¶æ˜¯æ•´å€‹ç¤ºæ„åœ–ç³»çµ±çš„æ ¸å¿ƒæ§åˆ¶é¢æ¿ï¼Œè®“ç”¨æˆ¶èƒ½å¤ è¼•é¬†ç®¡ç†å„ç¨®åœ–å±¤çš„é¡¯ç¤ºç‹€æ…‹ã€‚
   *
   * ğŸ¯ ä¸»è¦åŠŸèƒ½ (Core Features):
   * 1. ğŸ›ï¸ åœ–å±¤é¡¯ç¤ºæ§åˆ¶ï¼šæä¾›å®Œæ•´çš„åœ–å±¤é–‹é—œåŠŸèƒ½
   *    - ä¸€éµåˆ‡æ›åœ–å±¤çš„é¡¯ç¤º/éš±è—ç‹€æ…‹
   *    - å³æ™‚æ›´æ–°åœ–å±¤ç‹€æ…‹å’Œè¦–è¦ºåé¥‹
   *    - æ”¯æ´æ‰¹é‡åœ–å±¤æ“ä½œ
   * 2. ğŸ“Š è¼‰å…¥ç‹€æ…‹ç›£æ§ï¼šå¯¦æ™‚é¡¯ç¤ºåœ–å±¤è¼‰å…¥é€²åº¦
   *    - è¼‰å…¥ä¸­çš„è¦–è¦ºæŒ‡ç¤ºå™¨
   *    - è¼‰å…¥å®Œæˆçš„ç‹€æ…‹ç¢ºèª
   *    - è¼‰å…¥å¤±æ•—çš„éŒ¯èª¤æç¤º
   * 3. ğŸ” æ™ºèƒ½ç¯©é¸åŠŸèƒ½ï¼šå¿«é€Ÿå®šä½æ‰€éœ€åœ–å±¤
   *    - æŒ‰åŸå¸‚æˆ–å€åŸŸç¯©é¸åœ–å±¤
   *    - æŒ‰åœ–å±¤é¡å‹åˆ†é¡é¡¯ç¤º
   *    - æœå°‹åŠŸèƒ½å¿«é€Ÿå®šä½
   * 4. ğŸ“‹ åˆ†çµ„çµ„ç¹”ç®¡ç†ï¼šé‚è¼¯æ¸…æ™°çš„åœ–å±¤çµæ§‹
   *    - æŒ‰åŠŸèƒ½æˆ–ç”¨é€”åˆ†çµ„åœ–å±¤
   *    - å¯æŠ˜ç–Šçš„ç¾¤çµ„è¨­è¨ˆ
   *    - å±¤æ¬¡åŒ–çš„çµ„ç¹”çµæ§‹
   * 5. ğŸ¨ è¦–è¦ºç‹€æ…‹æŒ‡ç¤ºï¼šç›´è§€çš„ç‹€æ…‹åé¥‹ç³»çµ±
   *    - é¡è‰²ç·¨ç¢¼çš„ç‹€æ…‹æŒ‡ç¤º
   *    - åœ–ç¤ºåŒ–çš„ç‹€æ…‹è¡¨ç¤º
   *    - å‹•ç•«æ•ˆæœå¢å¼·ç”¨æˆ¶é«”é©—
   * 6. ğŸ“± éŸ¿æ‡‰å¼è¨­è¨ˆï¼šé©é…å„ç¨®è¨­å‚™å°ºå¯¸
   *    - æ¡Œé¢ç‰ˆï¼šå®Œæ•´åŠŸèƒ½å±•ç¤º
   *    - å¹³æ¿ç‰ˆï¼šå„ªåŒ–çš„è§¸æ§ä»‹é¢
   *    - æ‰‹æ©Ÿç‰ˆï¼šç°¡åŒ–çš„æ“ä½œæµç¨‹
   *
   * ğŸ—ï¸ æŠ€è¡“ç‰¹é» (Technical Features):
   * - Vue 3 Composition APIï¼šç¾ä»£åŒ–çš„çµ„ä»¶è¨­è¨ˆ
   * - Pinia ç‹€æ…‹ç®¡ç†ï¼šé›†ä¸­å¼çš„ç‹€æ…‹æ§åˆ¶
   * - éŸ¿æ‡‰å¼æ•¸æ“šç¶å®šï¼šå³æ™‚çš„ç‹€æ…‹åŒæ­¥
   * - äº‹ä»¶é©…å‹•æ¶æ§‹ï¼šé¬†è€¦åˆçš„çµ„ä»¶é€šä¿¡
   * - ç„¡éšœç¤™è¨­è¨ˆï¼šæ”¯æ´éµç›¤å°èˆªå’Œè¢å¹•é–±è®€å™¨
   *
   * ğŸ¨ è¦–è¦ºè¨­è¨ˆ (Visual Design):
   * - æ¸…æ™°çš„è¦–è¦ºå±¤æ¬¡ï¼Œçªå‡ºé‡è¦è³‡è¨Š
   * - ä¸€è‡´çš„è‰²å½©æ–¹æ¡ˆï¼Œä¿æŒå“ç‰Œçµ±ä¸€æ€§
   * - ç›´è§€çš„åœ–ç¤ºè¨­è¨ˆï¼Œé™ä½å­¸ç¿’æˆæœ¬
   * - é©ç•¶çš„é–“è·å’Œæ’ç‰ˆï¼Œæå‡å¯è®€æ€§
   *
   * ğŸš€ ä½¿ç”¨å ´æ™¯ (Use Cases):
   * - åœ°ç†è³‡è¨Šç³»çµ±çš„åœ–å±¤ç®¡ç†
   * - æ•¸æ“šè¦–è¦ºåŒ–å¹³å°çš„åœ–å±¤æ§åˆ¶
   * - äº’å‹•å¼åœ°åœ–çš„åœ–å±¤åˆ‡æ›
   * - å¤šç¶­åº¦æ•¸æ“šçš„å±¤æ¬¡å±•ç¤º
   * - åˆ†æå·¥å…·çš„åŠŸèƒ½æ¨¡çµ„é¸æ“‡
   *
   * ğŸ“± éŸ¿æ‡‰å¼æ”¯æ´ (Responsive Support):
   * - æ¡Œé¢ç‰ˆï¼šå®Œæ•´çš„åŠŸèƒ½å’Œè©³ç´°è³‡è¨Š
   * - å¹³æ¿ç‰ˆï¼šè§¸æ§å„ªåŒ–çš„ä»‹é¢è¨­è¨ˆ
   * - æ‰‹æ©Ÿç‰ˆï¼šç°¡åŒ–çš„æ“ä½œå’Œæ ¸å¿ƒåŠŸèƒ½
   *
   * ğŸ”§ çµ„ä»¶ API (Component API):
   * - æ¥æ”¶åœ–å±¤æ•¸æ“šï¼šå¾ Pinia store ç²å–åœ–å±¤é…ç½®
   * - äº‹ä»¶ç™¼å°„ï¼šå‘çˆ¶çµ„ä»¶ç™¼é€åœ–å±¤ç‹€æ…‹è®Šæ›´äº‹ä»¶
   * - ç‹€æ…‹ç®¡ç†ï¼šç¶­è­·åœ–å±¤çš„æœ¬åœ°ç‹€æ…‹
   *
   * @component LayersTab
   * @version 2.0.0
   * @author Kevin Cheng
   * @since 1.0.0
   */

  // ğŸ”§ Vue Composition API å¼•å…¥ (Vue Composition API Imports)
  import { computed, ref } from 'vue'; // å¼•å…¥éŸ¿æ‡‰å¼ API
  import { useDataStore } from '@/stores/dataStore.js'; // å¼•å…¥è³‡æ–™å­˜å„²

  export default {
    name: 'LayersTab',

    /**
     * ğŸ”§ çµ„ä»¶è¨­å®šå‡½æ•¸ (Component Setup)
     * ä½¿ç”¨ Composition API è¨­å®šçµ„ä»¶é‚è¼¯å’Œç‹€æ…‹ç®¡ç†
     */
    setup() {
      // ğŸ“¦ å–å¾— Pinia æ•¸æ“šå­˜å„²å¯¦ä¾‹ (Get Pinia Data Store Instance)
      const dataStore = useDataStore();

      // ğŸ“š çµ„ä»¶å¼•ç”¨ (Component References)
      /** ğŸ“‹ åœ–å±¤åˆ—è¡¨ DOM å…ƒç´ å¼•ç”¨ï¼Œç”¨æ–¼æ»¾å‹•å’Œæ“ä½œ */
      const layerListRef = ref(null);

      // ğŸ§® è¨ˆç®—å±¬æ€§ (Computed Properties)
      /** ğŸ“Š å¾ store ä¸­ç²å–åœ–å±¤æ•¸æ“šï¼Œç•¶ store ç‹€æ…‹æ”¹è®Šæ™‚è‡ªå‹•æ›´æ–° */
      const layers = computed(() => dataStore.layers);

      // ğŸ”§ åœ–å±¤æ“ä½œå‡½æ•¸ (Layer Operation Functions)

      /**
       * ğŸ”˜ åˆ‡æ›åœ–å±¤å¯è¦‹æ€§ (Toggle Layer Visibility)
       * å‘¼å« store ä¸­çš„ action ä¾†åˆ‡æ›æŒ‡å®šåœ–å±¤çš„é¡¯ç¤º/éš±è—ç‹€æ…‹
       *
       * @param {string} layerId - è¦åˆ‡æ›çš„åœ–å±¤ ID
       */
      const toggleLayer = (layerId) => {
        dataStore.toggleLayerVisibility(layerId);
      };

      /**
       * ğŸ›ï¸ è™•ç†é–‹é—œè®Šæ›´äº‹ä»¶ (Handle Toggle Change Event)
       * é¿å…é‡è¤‡è§¸ç™¼ï¼Œåªåœ¨å¯¦éš›éœ€è¦æ™‚åˆ‡æ›åœ–å±¤
       * æä¾›è©³ç´°çš„ç‹€æ…‹æª¢æŸ¥å’ŒéŒ¯èª¤è™•ç†
       *
       * @param {string} layerId - åœ–å±¤ ID
       * @param {Event} event - è®Šæ›´äº‹ä»¶å°è±¡
       */
      const handleToggleChange = (layerId, event) => {
        // é˜²æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¸ç™¼çˆ¶å…ƒç´ çš„äº‹ä»¶
        event.stopPropagation();

        // åœ¨æ‰€æœ‰åœ–å±¤ç¾¤çµ„ä¸­æŸ¥æ‰¾æŒ‡å®šçš„åœ–å±¤
        const layer = dataStore.layers
          .flatMap((mainGroup) => mainGroup.groupLayers)
          .find((l) => l.layerId === layerId);

        // æª¢æŸ¥åœ–å±¤æ˜¯å¦å­˜åœ¨
        if (!layer) {
          console.error('âŒ LayersTab: æ‰¾ä¸åˆ°åœ–å±¤', layerId);
          return;
        }

        // è¨˜éŒ„è©³ç´°çš„ç‹€æ…‹è³‡è¨Šç”¨æ–¼é™¤éŒ¯
        // åªæœ‰ç•¶ç•¶å‰ç‹€æ…‹èˆ‡ checkbox ç‹€æ…‹ä¸ä¸€è‡´æ™‚æ‰åˆ‡æ›
        // é€™å¯ä»¥é¿å…é‡è¤‡è§¸ç™¼å’Œç‹€æ…‹è¡çª
        if (layer.visible !== event.target.checked) {
          dataStore.toggleLayerVisibility(layerId);
        }
      };

      // ğŸ“¤ è¿”å›éŸ¿æ‡‰å¼æ•¸æ“šå’Œæ–¹æ³•çµ¦æ¨¡æ¿ä½¿ç”¨ (Return Reactive Data and Methods for Template)
      return {
        // ğŸ“Š åœ–å±¤æ•¸æ“šå’Œç‹€æ…‹ (Layer Data and States)
        layers, // åœ–å±¤ç¾¤çµ„æ•¸æ“š
        layerListRef, // åœ–å±¤åˆ—è¡¨ DOM å¼•ç”¨

        // ğŸ”§ åœ–å±¤æ“ä½œå‡½æ•¸ (Layer Operation Functions)
        toggleLayer, // åˆ‡æ›åœ–å±¤å¯è¦‹æ€§
        handleToggleChange, // è™•ç†é–‹é—œè®Šæ›´äº‹ä»¶

        // ğŸ› ï¸ å·¥å…·å‡½æ•¸ (Utility Functions)
      };
    },
  };
</script>

<template>
  <div class="h-100 d-flex flex-column overflow-hidden my-bgcolor-gray-100">
    <div class="flex-grow-1 overflow-auto layer-list-container" ref="layerListRef">
      <div class="mb-3">
        <!-- ä¸»ç¾¤çµ„ -->
        <div v-for="mainGroup in layers" :key="mainGroup.groupName" class="p-3">
          <!-- ä¸»ç¾¤çµ„æ¨™é¡Œ -->
          <div class="d-flex align-items-center pb-2">
            <div class="my-title-xs-gray">{{ mainGroup.groupName }}</div>
          </div>

          <!-- åœ–å±¤åˆ—è¡¨ -->
          <div v-for="layer in mainGroup.groupLayers" :key="layer.layerId" class="mb-1">
            <!-- åœ–å±¤å¡ç‰‡ -->
            <div class="btn rounded-0 border-0 d-flex shadow-sm my-bgcolor-white-hover p-0">
              <!-- åœ–å±¤åœ–ç¤º -->
              <div :class="`my-bgcolor-${layer.colorName}`" style="min-width: 6px"></div>
              <div class="w-100">
                <div class="d-flex">
                  <!-- åœ–å±¤åç¨± - é»æ“Šå¯åˆ‡æ›åœ–å±¤ -->
                  <div
                    class="d-flex align-items-center text-start w-100 px-3 py-2 cursor-pointer"
                    @click="toggleLayer(layer.layerId)"
                  >
                    <span class="my-content-sm-black">
                      {{ layer.layerName }}
                      <span class="my-content-xs-gray ms-2">
                        {{ layer.dashboardData?.totalCount }}
                      </span>
                    </span>
                  </div>
                  <!-- åˆ‡æ›åœ–å±¤å¯è¦‹æ€§ - åªæœ‰é–‹é—œæœ¬èº«è™•ç†åˆ‡æ› -->
                  <div
                    class="d-flex align-items-center justify-content-center px-3 py-2"
                    @click.stop
                  >
                    <input
                      type="checkbox"
                      :id="'switch-' + layer.layerId"
                      :checked="layer.visible"
                      :disabled="layer.isLoading"
                      @change="handleToggleChange(layer.layerId, $event)"
                    />
                    <label :for="'switch-' + layer.layerId"></label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<style scoped>
  /* ğŸ¨ åœ–å±¤åˆ‡æ›é–‹é—œæ¨£å¼ (Layer Toggle Switch Styles) */
  /* https://www.tpisoftware.com/tpu/articleDetails/2744 */

  .cursor-pointer {
    cursor: pointer;
  }

  /* è¼‰å…¥ä¸­çš„åœ–å±¤é¡¯ç¤ºä¸åŒæ¨£å¼ */
  .btn:has(input:disabled) {
    opacity: 0.7;
  }

  input[type='checkbox'] {
    height: 0;
    width: 0;
    visibility: hidden;
  }

  label {
    cursor: pointer;
    width: 28px;
    height: 16px;
    background: var(--my-color-gray-300);
    display: block;
    border-radius: 16px;
    position: relative;
    transition: background-color 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* å„ªåŒ–èƒŒæ™¯è‰²éæ¸¡ */
  }

  label:after {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 12px;
    height: 12px;
    background: var(--my-color-white);
    border-radius: 12px;
    transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1); /* å„ªåŒ–æ»‘å‹•éæ¸¡ */
  }

  input:checked + label {
    background: var(--my-color-green);
  }

  input:checked + label:after {
    transform: translateX(12px);
  }

  /* ç¦ç”¨ç‹€æ…‹æ¨£å¼ */
  input:disabled + label {
    cursor: not-allowed;
    opacity: 0.6;
    background: var(--my-color-gray-200);
  }

  input:disabled + label:after {
    background: var(--my-color-gray-300);
  }
</style>
